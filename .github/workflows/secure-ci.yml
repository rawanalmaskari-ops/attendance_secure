name: Secure CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  security-pipeline:
    runs-on: ubuntu-latest

    steps:
    # 1. سحب الكود من الريبو
    - uses: actions/checkout@v3

    # 2. تجهيز Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    # 3. تثبيت المتطلبات + أدوات الأمان
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety flask gunicorn

    # 4. SAST: تحليل أمان للكود
    - name: Run Bandit (SAST)
      run: |
        bandit -r . -ll

    # 5. SCA: تحليل المكتبات
    - name: Check Dependencies with Safety (SCA)
      run: |
        safety check --full-report

    # 6. تشغيل التطبيق في الخلفية باستخدام gunicorn
    - name: Run App in Background
      run: |
        nohup gunicorn --bind 0.0.0.0:5000 app:app &
        sleep 10   # اعطيه وقت يشتغل

    # 7. DAST: هجوم ديناميكي عبر OWASP ZAP
    - name: Run OWASP ZAP Baseline Scan (DAST)
      uses: zaproxy/action-baseline@v0.12.0
      with:
        target: "http://localhost:5000"
        rules_file_name: "default_policy.conf"
        fail_on_error: true

    # 8. إيقاف السيرفر بعد الفحص (اختياري)
    - name: Stop App
      run: |
        pkill -f "gunicorn --bind 0.0.0.0:5000"
